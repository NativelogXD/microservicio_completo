<div class="dashboard-container">
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2 class="sidebar-title">Portal de Operaciones</h2>
    </div>

    <nav class="sidebar-nav">
      <ul class="menu-list">
        <li class="menu-item">
          <a href="/">
            <i class="fas fa-home"></i>
            <span>Inicio</span>
          </a>
        </li>
        <li class="menu-item active">
          <a href="/agent">
            <i class="fas fa-robot"></i>
            <span>Agente de IA</span>
          </a>
        </li>
        <li class="menu-item">
          <a href="/vuelos">
            <i class="fa-solid fa-plane-up"></i>
            <span>Vuelos Disponibles</span>
          </a>
        </li>
        <li class="menu-item">
          <a href="/reservas">
            <i class="fa-solid fa-ticket"></i>
            <span>Mis Reservaciones</span>
          </a>
        </li>
        <li class="menu-item" *ngIf="isAdmin">
          <a href="/empleados">
            <i class="fas fa-users"></i>
            <span>Empleados</span>
          </a>
        </li>
        <li class="menu-item" *ngIf="isAdmin">
          <a href="/mantenimientos">
            <i class="fas fa-tools"></i>
            <span>Mantenimiento</span>
          </a>
        </li>
        <li class="menu-item" *ngIf="isAdmin">
          <a href="/aviones">
            <i class="fa-solid fa-plane-arrival"></i>
            <span>Registro de Aviones</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Menú de usuario -->
    <div class="sidebar-footer">
      <div class="user-menu">
        <div class="user-info" (click)="toggleUserMenu()">
          <i class="fas fa-user-circle"></i>
          <span>{{ usuario?.nombre || 'Invitado' }}</span>
          <i class="fas fa-chevron-down dropdown-arrow" [class.rotate]="isUserMenuOpen"></i>
        </div>

        <div class="user-dropdown" [class.show]="isUserMenuOpen">
          <button *ngIf="!isUserRegistered" class="dropdown-item" (click)="handleLogin()">
            <i class="fas fa-sign-in-alt"></i>
            <span>Iniciar Sesión</span>
          </button>
          <button *ngIf="!isUserRegistered" class="dropdown-item" (click)="handleRegister()">
            <i class="fas fa-user-plus"></i>
            <span>Registrarse</span>
          </button>
          <button *ngIf="isUserRegistered" class="dropdown-item" (click)="handleEdit()">
            <i class="fas fa-user-cog"></i>
            <span>Editar Perfil</span>
          </button>
        </div>
      </div>
    </div>
  </aside>

  <main class="main-content">
    <!-- Sección del agente -->
    <div class="chat-section">
      <div class="main-container">
        <header class="chat-header">
          <h1 class="chat-title">Agente IA Aetheris</h1>
          <button class="reset-button" (click)="resetChat()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            <span>Reiniciar Agente</span>
          </button>
        </header>

        <div class="chat-area" #chatArea>
          <div class="message-container">
            <div class="message" [ngClass]="message.type" *ngFor="let message of messages; trackBy: trackByIndex">
              <p class="message-text">{{ message.text }}</p>
              <span class="message-time">{{ message.time }}</span>

              <button *ngIf="message.type === 'ai'" class="voice-btn" (click)="speakMessage(message.text)">
                <i class="fas fa-volume-up"></i>
              </button>
            </div>

            <div *ngIf="isLoading" class="message ai loading-message">
              <div class="loading-indicator">
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
                <span class="loading-text">El agente está escribiendo...</span>
              </div>
            </div>
          </div>
        </div>

        <div class="input-area">
          <div class="input-wrapper" [class.loading]="isLoading">
            <input type="text" class="message-input" [(ngModel)]="messageText" (keypress)="onKeyPress($event)"
              placeholder="{{ isLoading ? 'Esperando respuesta...' : 'Escribe tu mensaje...' }}" [disabled]="isLoading">
            <button class="send-button" (click)="sendMessage()" [disabled]="isLoading || !messageText.trim()"
              [class.disabled]="isLoading || !messageText.trim()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>

            <button class="mic-button" (click)="startListening()" [disabled]="isLoading" [class.disabled]="isLoading">
              <i class="fas fa-microphone"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel derecho de tablas dinámicas -->
    <aside class="tables-panel">
      <div class="tables-content">
        <!-- Estado vacío -->
        <div *ngIf="dynamicTables.length === 0" class="empty-state">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
          </svg>
          <p>No hay tablas disponibles</p>
          <span>Las tablas se crearán dinámicamente</span>
        </div>

        <!-- Tablas dinámicas editables -->
        <div *ngFor="let table of dynamicTables; let i = index" class="table-card table-container">
          <div class="table-card-header">
            <h3 class="table-card-title">{{ table.title }}</h3>
            <button class="remove-table-button" (click)="removeTable(i)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>

          <div class="table-wrapper">
            <table class="dynamic-table">
              <thead>
                <tr>
                  <th *ngFor="let col of table.columns">{{ col }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of table.rows; let r = index">
                  <td *ngFor="let col of table.columns">
                    <ng-container *ngIf="table.isReadOnly; else editableCell">
                      <span class="readonly-cell">{{ table.rows[r][col] || '—' }}</span>
                    </ng-container>
                    <ng-template #editableCell>
                      <ng-container [ngSwitch]="getFieldType(table.title, col)">
                        <select *ngSwitchCase="'select'" [(ngModel)]="table.rows[r][col]" class="form-control">
                          <option *ngFor="let opt of getSelectOptions(table.title, col)" [value]="opt">{{ opt }}</option>
                        </select>
                        <input *ngSwitchCase="'number'" type="number" [(ngModel)]="table.rows[r][col]" placeholder="Ingrese {{ col }}" class="form-control" />
                        <input *ngSwitchCase="'date'" type="date" [(ngModel)]="table.rows[r][col]" placeholder="Ingrese {{ col }}" class="form-control" />
                        <input *ngSwitchCase="'time'" type="time" [(ngModel)]="table.rows[r][col]" placeholder="Ingrese {{ col }}" class="form-control" />
                        <input *ngSwitchDefault type="text" [(ngModel)]="table.rows[r][col]" placeholder="Ingrese {{ col }}" class="form-control" />
                      </ng-container>
                    </ng-template>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="table-footer actions">
            <button class="action-btn danger" (click)="removeTable(i)">Eliminar</button>
            <button class="action-btn success" *ngIf="!table.isReadOnly" (click)="confirmTable(i)" [disabled]="isLoading">Confirmar</button>
            <span class="table-mode" *ngIf="table.isReadOnly">Solo lectura</span>
            <span class="table-info">{{ table.rows.length }} filas</span>
            <span class="table-timestamp">{{ table.timestamp }}</span>
          </div>
        </div>
      </div>
    </aside>
  </main>
</div>
